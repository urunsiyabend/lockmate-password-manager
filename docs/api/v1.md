# Lockmate REST API Contract (v1)

This document describes the versioned REST interface exposed by the Lockmate Password Manager. All endpoints are served beneath the `/api/v1` base path and return JSON payloads. Unless otherwise noted, requests and responses use UTF-8 encoding.

## Conventions

- **Authentication:** Endpoints marked with ðŸ”’ require a bearer token supplied via `Authorization: Bearer <JWT>`.
- **Idempotency:** `PUT` and `PATCH` requests are idempotent on the specified resource.
- **Timestamps:** All timestamps follow ISO-8601 format with UTC offsets.
- **Errors:** Failures return an `error` object with `code`, `message`, and optional `details` fields. Common status codes include `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `404 Not Found`, and `409 Conflict`.

## Authentication

### POST /api/v1/auth/register
Registers a new Lockmate account.

**Request body**
```json
{
  "email": "jane@example.com",
  "username": "jane",
  "password": "P@ssw0rd!",
  "master_password_hint": "Favorite travel city"
}
```

**Successful response â€” 201 Created**
```json
{
  "id": "user_123",
  "email": "jane@example.com",
  "username": "jane",
  "created_at": "2024-04-01T12:00:00Z"
}
```

### POST /api/v1/auth/login
Authenticates a user and returns a signed JWT along with key derivation material.

**Request body**
```json
{
  "username": "jane",
  "password": "P@ssw0rd!"
}
```

**Successful response â€” 200 OK**
```json
{
  "token": "<jwt>",
  "refresh_token": "<opaque-token>",
  "expires_at": "2024-04-01T13:00:00Z",
  "user": {
    "id": "user_123",
    "email": "jane@example.com",
    "username": "jane"
  },
  "key_salt": "base64-encoded-salt"
}
```

### POST /api/v1/auth/token/refresh
ðŸ”’ Exchanges a refresh token for a new access token pair.

**Request body**
```json
{
  "refresh_token": "<opaque-token>"
}
```

**Successful response â€” 200 OK**
```json
{
  "token": "<jwt>",
  "refresh_token": "<opaque-token>",
  "expires_at": "2024-04-01T14:00:00Z"
}
```

### POST /api/v1/auth/logout
ðŸ”’ Revokes the presented refresh token and invalidates the active session.

**Request body**
```json
{
  "refresh_token": "<opaque-token>"
}
```

**Successful response â€” 204 No Content**

### GET /api/v1/auth/session
ðŸ”’ Returns profile metadata for the authenticated subject.

**Successful response â€” 200 OK**
```json
{
  "id": "user_123",
  "email": "jane@example.com",
  "username": "jane",
  "created_at": "2024-04-01T12:00:00Z"
}
```

## Vaults

Vaults organize encrypted secrets. Each vault can contain multiple items and access policies for sharing.

### GET /api/v1/vaults
ðŸ”’ Lists vaults the caller can access.

**Query parameters**
- `cursor` (optional): pagination cursor.
- `limit` (optional): number of results to return (default 25, max 100).

**Successful response â€” 200 OK**
```json
{
  "data": [
    {
      "id": "vault_abc",
      "name": "Personal",
      "owner_id": "user_123",
      "created_at": "2024-04-01T12:00:00Z",
      "updated_at": "2024-04-01T12:00:00Z",
      "item_count": 42
    }
  ],
  "next_cursor": null
}
```

### POST /api/v1/vaults
ðŸ”’ Creates a new vault container.

**Request body**
```json
{
  "name": "Shared marketing vault",
  "description": "Credentials used by the marketing team"
}
```

**Successful response â€” 201 Created**
```json
{
  "id": "vault_abc",
  "name": "Shared marketing vault",
  "description": "Credentials used by the marketing team",
  "owner_id": "user_123",
  "created_at": "2024-04-01T12:00:00Z",
  "updated_at": "2024-04-01T12:00:00Z"
}
```

### GET /api/v1/vaults/{vault_id}
ðŸ”’ Retrieves metadata for a vault plus high-level sharing information.

**Successful response â€” 200 OK**
```json
{
  "id": "vault_abc",
  "name": "Shared marketing vault",
  "description": "Credentials used by the marketing team",
  "owner_id": "user_123",
  "created_at": "2024-04-01T12:00:00Z",
  "updated_at": "2024-04-01T12:05:00Z",
  "members": [
    {
      "user_id": "user_123",
      "role": "owner",
      "status": "active"
    },
    {
      "user_id": "user_456",
      "role": "editor",
      "status": "pending"
    }
  ]
}
```

### PATCH /api/v1/vaults/{vault_id}
ðŸ”’ Updates vault metadata.

**Request body**
```json
{
  "name": "Shared marketing vault",
  "description": "Credentials shared with the marketing and product teams"
}
```

**Successful response â€” 200 OK** returns the updated vault resource.

### DELETE /api/v1/vaults/{vault_id}
ðŸ”’ Soft deletes a vault and all associated items.

**Successful response â€” 204 No Content**

## Vault Items

All vault item payloads are encrypted client-side. The API stores opaque ciphertext along with minimal searchable metadata supplied by the client.

### GET /api/v1/vaults/{vault_id}/items
ðŸ”’ Lists encrypted items within a vault.

**Query parameters**
- `cursor`, `limit`: pagination controls.
- `tag`: optional tag filter.

**Successful response â€” 200 OK**
```json
{
  "data": [
    {
      "id": "item_xyz",
      "vault_id": "vault_abc",
      "label": "Lockmate marketing Twitter",
      "ciphertext": "base64-blob",
      "tags": ["social", "marketing"],
      "created_at": "2024-04-01T12:00:00Z",
      "updated_at": "2024-04-02T09:30:00Z"
    }
  ],
  "next_cursor": null
}
```

### POST /api/v1/vaults/{vault_id}/items
ðŸ”’ Creates an encrypted vault item.

**Request body**
```json
{
  "label": "Lockmate marketing Twitter",
  "ciphertext": "base64-blob",
  "tags": ["social", "marketing"],
  "checksum": "sha256:..."
}
```

**Successful response â€” 201 Created** returns the stored item with system metadata.

### GET /api/v1/vaults/{vault_id}/items/{item_id}
ðŸ”’ Retrieves a single item record.

**Successful response â€” 200 OK** returns the encrypted record.

### PATCH /api/v1/vaults/{vault_id}/items/{item_id}
ðŸ”’ Updates the ciphertext payload and metadata. Request body mirrors the create format.

### DELETE /api/v1/vaults/{vault_id}/items/{item_id}
ðŸ”’ Removes an item from the vault. Returns `204 No Content`.

## Sharing

Lockmate supports user-to-user vault sharing via invitations and role assignments.

### POST /api/v1/vaults/{vault_id}/shares
ðŸ”’ Invites another user to access a vault.

**Request body**
```json
{
  "email": "sam@example.com",
  "role": "editor",
  "message": "Join the marketing vault"
}
```

**Successful response â€” 201 Created**
```json
{
  "id": "share_invite_789",
  "vault_id": "vault_abc",
  "inviter_id": "user_123",
  "invitee_email": "sam@example.com",
  "role": "editor",
  "status": "pending",
  "created_at": "2024-04-01T12:10:00Z"
}
```

### GET /api/v1/vaults/{vault_id}/shares
ðŸ”’ Lists active and pending sharing relationships for a vault.

**Successful response â€” 200 OK** returns an array of share records with `id`, `invitee_email`, `role`, `status`, and timestamps.

### PATCH /api/v1/vaults/{vault_id}/shares/{share_id}
ðŸ”’ Updates the invite role or status (e.g., revoke before acceptance).

**Request body**
```json
{
  "role": "viewer",
  "status": "revoked"
}
```

**Successful response â€” 200 OK** returns the updated share record.

### DELETE /api/v1/vaults/{vault_id}/shares/{share_id}
ðŸ”’ Immediately revokes the invitation or access record. Returns `204 No Content`.

### POST /api/v1/shares/{share_id}/accept
Allows an invitee to accept a pending share by presenting the invitation token.

**Request body**
```json
{
  "invite_token": "<signed-token>",
  "public_key": "base64-public-key"
}
```

**Successful response â€” 200 OK** returns the resulting membership entry.

## Webhooks

Lockmate can optionally notify third-party services about security-sensitive actions.

### POST /api/v1/webhooks/test
ðŸ”’ Validates a webhook configuration by dispatching a signed sample event.

**Successful response â€” 202 Accepted** with a `request_id` for auditing.

## Changelog

- **v1.0.0** â€” Initial contract covering authentication, vault operations, item management, and sharing workflows.
